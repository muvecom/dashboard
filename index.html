<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Conversas IA - Helena CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* MANTENDO TODO O SEU ESTILO ORIGINAL */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #4f6df5 0%, #3a56d6 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2.5rem; margin-bottom: 15px; color: #4f6df5; }
        .stat-value { font-size: 2.2rem; font-weight: bold; color: #3a56d6; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background-color: #4f6df5; color: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }
        .status-qualificado { background-color: #e8f5e9; color: #2e7d32; }
        .status-n-qualificado { background-color: #ffebee; color: #c62828; }
        .temp-quente { color: #d32f2f; font-weight: bold; }
        .temp-morno { color: #f57c00; font-weight: bold; }
        
        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; width: 90%; max-width: 500px; border-radius: 10px; overflow: hidden; }
        .modal-header { background: #4f6df5; color: white; padding: 20px; display: flex; justify-content: space-between; }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .btn-submit { background: #4f6df5; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; }
        
        .loading { text-align: center; padding: 40px; }
        .fa-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> Dashboard Atendimento IA</h1>
            <p>Monitoramento de Leads e Qualificação de Pneus em Tempo Real</p>
        </header>

        <div id="initial-loading" class="loading">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p style="margin-top:15px">Aguardando Autenticação...</p>
        </div>

        <div id="dashboard-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-comments"></i>
                    <h3>Total Conversas</h3>
                    <div class="stat-value" id="total-conversas">0</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-fire"></i>
                    <h3>Leads Quentes</h3>
                    <div class="stat-value" id="total-quentes">0</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-thermometer-half"></i>
                    <h3>Leads Mornos</h3>
                    <div class="stat-value" id="total-mornos">0</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-slash"></i>
                    <h3>Não Qualificados</h3>
                    <div class="stat-value" id="total-n-qualificados">0</div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Contato</th>
                            <th>Marca/Pneu</th>
                            <th>Medida</th>
                            <th>Qualificação</th>
                            <th>Temperatura</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody id="table-content"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="token-modal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>Acesso Restrito</h3></div>
            <div class="modal-body" style="text-align:center">
                <i class="fas fa-key fa-3x" style="color:#4f6df5; margin-bottom:15px"></i>
                <p>Insira seu Token da Helena CRM para acessar os dados.</p>
                <div class="form-group" style="margin-top:20px">
                    <input type="password" id="token-input" placeholder="Digite o token...">
                </div>
                <button class="btn-submit" id="btn-token">Acessar Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO DE NEGÓCIO
        const MARCAS = ['MICHELIN', 'PIRELLI', 'GOODYEAR', 'CONTINENTAL', 'DUNLOP', 'BRIDGESTONE', 'FIRESTONE'];
        const QUALIFICADORES = ['PNEU', 'BALANCEAMENTO', 'ALINHAMENTO', 'RODA', 'CAMBAGEM', 'SUSPENSAO', 'BORRACHARIA'];
        const TERMOS_QUENTE = ['HOJE', 'AMANHÃ', 'AMANA', 'AGORA', 'URGENTE', 'INSTALAR', 'COMPRAR', 'ESTOU INDO', '15 DIAS'];

        let currentToken = null;
        let processedConversations = [];

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');

            if (tokenFromUrl) {
                currentToken = tokenFromUrl;
                // Limpar token da URL para segurança (opcional, mas recomendado)
                const newUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
                loadDashboardData();
            } else {
                document.getElementById('initial-loading').style.display = 'none';
                document.getElementById('token-modal').classList.add('active');
            }

            document.getElementById('btn-token').addEventListener('click', () => {
                const input = document.getElementById('token-input').value.trim();
                if(input) {
                    currentToken = input;
                    document.getElementById('token-modal').classList.remove('active');
                    document.getElementById('initial-loading').style.display = 'block';
                    loadDashboardData();
                }
            });
        });

        async function loadDashboardData() {
            try {
                const headers = { 
                    'Authorization': `Bearer ${currentToken}`,
                    'accept': 'application/json' 
                };

                // 1. Buscar Sessões (Listar Conversas)
                const resSessions = await fetch('https://api.helena.run/chat/v2/session?PageSize=40&OrderDirection=DESCENDING', { headers });
                if (!resSessions.ok) throw new Error("Falha na autenticação");
                
                const sessions = await resSessions.json();
                
                // Filtro: Apenas conversas que passaram pelo Bot
                const botSessions = sessions.items.filter(s => s.botId !== null);
                
                let stats = { quente: 0, morno: 0, n_qual: 0 };
                let results = [];

                for (const session of botSessions) {
                    // 2. Buscar Mensagens para qualificar o lead
                    const resMsgs = await fetch(`https://api.helena.run/chat/v1/message?SessionId=${session.id}&PageSize=20`, { headers });
                    const msgs = await resMsgs.json();
                    
                    // Texto bruto do cliente
                    const fullText = msgs.items
                        .filter(m => !m.botId) // Mensagens que NÃO são do bot
                        .map(m => m.text?.toUpperCase() || "")
                        .join(" ");

                    // Lógica de Qualificação
                    const isQualificado = QUALIFICADORES.some(q => fullText.includes(q)) || MARCAS.some(m => fullText.includes(m));
                    let status = "NÃO QUALIFICADO";
                    let temp = "-";
                    
                    if (isQualificado) {
                        status = "QUALIFICADO";
                        const isQuente = TERMOS_QUENTE.some(t => fullText.includes(t));
                        temp = isQuente ? "QUENTE" : "MORNO";
                        if (isQuente) stats.quente++; else stats.morno++;
                    } else {
                        stats.n_qual++;
                    }

                    // Regex de Pneu (175/70R14, 205/55R16 etc)
                    const pneuMatch = fullText.match(/\d{3}\/\d{2}\s?R\d{2}/);
                    const marcaDestaque = MARCAS.find(m => fullText.includes(m)) || "Multimarcas";

                    results.push({
                        id: session.id,
                        data: new Date(session.createdAt).toLocaleString('pt-BR'),
                        contato: session.contactDetails?.displayName || "Desconhecido",
                        marca: marcaDestaque,
                        medida: pneuMatch ? pneuMatch[0] : "N/A",
                        status: status,
                        temp: temp
                    });
                }

                renderDashboard(results, stats);

            } catch (err) {
                alert("Erro ao carregar dados: " + err.message);
                document.getElementById('token-modal').classList.add('active');
                document.getElementById('initial-loading').style.display = 'none';
            }
        }

        function renderDashboard(data, stats) {
            document.getElementById('initial-loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';

            // Atualiza Counters
            document.getElementById('total-conversas').innerText = data.length;
            document.getElementById('total-quentes').innerText = stats.quente;
            document.getElementById('total-mornos').innerText = stats.morno;
            document.getElementById('total-n-qualificados').innerText = stats.n_qual;

            // Alimenta Tabela
            const tbody = document.getElementById('table-content');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.data}</td>
                    <td><strong>${item.contato}</strong></td>
                    <td>${item.marca}</td>
                    <td><code>${item.medida}</code></td>
                    <td><span class="status-badge ${item.status === 'QUALIFICADO' ? 'status-qualificado' : 'status-n-qualificado'}">${item.status}</span></td>
                    <td><span class="${item.temp === 'QUENTE' ? 'temp-quente' : 'temp-morno'}">${item.temp}</span></td>
                    <td>
                        <a href="https://app.helena.run/chat/${item.id}" target="_blank" style="color:#4f6df5; text-decoration:none">
                            <i class="fas fa-external-link-alt"></i> Ver Chat
                        </a>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
